# MotionWeaver æ·±åº¦ä¼˜åŒ– â€” è¯¦ç»†å®æ–½æ–¹æ¡ˆ

> æ—¥æœŸ: 2026-02-15 | ä¼˜å…ˆçº§: P0 â†’ P3 | æ¶‰åŠ 9 å¤§æ–¹å‘

---

## æ–¹å‘ä¸€ [P0]: Quick Draft ä¸€é”®é¢„è§ˆæ¨¡å¼

### ç›®æ ‡
ç”¨æˆ·è¾“å…¥ä¸€å¥è¯çµæ„Ÿ(logline),ä¸€é”®è·‘å®Œå…¨æµç¨‹(å¤§çº² â†’ å‰§æœ¬ â†’ åˆ†é•œ â†’ å›¾ç‰‡ â†’ TTS â†’ è§†é¢‘ â†’ åˆæˆ),30 åˆ†é’Ÿå†…çœ‹åˆ°å®Œæ•´ç²—ç³™é¢„è§ˆã€‚

### ç°çŠ¶åˆ†æ
`test_pipeline.py` å·²å®ç°åŒæ­¥å…¨æµç¨‹,ä½†:
- åªæ˜¯ä¸€ä¸ªæµ‹è¯•ç«¯ç‚¹,æ²¡æœ‰äº§å“åŒ–
- åŒæ­¥é˜»å¡,å•ä¸ªè¯·æ±‚å¯èƒ½è·‘ 10+ åˆ†é’Ÿ
- æ²¡æœ‰è¿›åº¦æ¨é€,ç”¨æˆ·çœ‹ä¸åˆ°è¿›å±•
- ä¸æ”¯æŒä¸­é€”å–æ¶ˆ

### è¯¦ç»†è®¾è®¡

#### æ•°æ®æ¨¡å‹å˜æ›´

```python
# [MODIFY] backend/app/models/project.py
class ProjectMode(str, enum.Enum):
    """é¡¹ç›®åˆ›ä½œæ¨¡å¼"""
    STANDARD = "STANDARD"      # æ ‡å‡†é€æ­¥å®¡æ ¸æ¨¡å¼
    QUICK_DRAFT = "QUICK_DRAFT"  # ä¸€é”®é¢„è§ˆæ¨¡å¼

# Project è¡¨æ–°å¢å­—æ®µ
class Project(Base):
    mode: Mapped[str] = mapped_column(
        String(50), nullable=False, default=ProjectMode.STANDARD.value
    )
    draft_progress: Mapped[Optional[str]] = mapped_column(
        String(500), nullable=True  # JSON: {"step": "image_gen", "current": 3, "total": 5}
    )
```

#### åç«¯å®ç°

```
[NEW] backend/app/tasks/quick_draft_task.py
```

æ ¸å¿ƒ Celery ä»»åŠ¡,ç¼–æ’å®Œæ•´æµç¨‹:

```python
@shared_task(bind=True, time_limit=1800)
def run_quick_draft(self, project_id: str, logline: str):
    """ä¸€é”®é¢„è§ˆå…¨æµç¨‹ â€” Celery åå°æ‰§è¡Œ,é€šè¿‡ Pub/Sub æ¨é€è¿›åº¦"""
    
    steps = [
        ("outline", "ç”Ÿæˆå¤§çº²..."),
        ("script", "æ’°å†™å‰§æœ¬..."),
        ("parse_scenes", "è§£æåˆ†é•œ..."),
        ("image_gen", "ç»˜åˆ¶ç”»é¢..."),
        ("tts", "åˆæˆè¯­éŸ³..."),
        ("video_gen", "ç”ŸæˆåŠ¨ç”»..."),
        ("compose", "åˆæˆæˆç‰‡..."),
    ]
    
    for i, (step, desc) in enumerate(steps):
        _publish_progress(project_id, step, i+1, len(steps), desc)
        
        if step == "outline":
            outline = run_async(generate_outline(logline))
            _update_project(project_id, outline_text=outline)
            
        elif step == "script":
            script = run_async(generate_script(outline))
            _update_project(project_id, script_text=script)
            
        elif step == "parse_scenes":
            scenes = run_async(parse_scenes(script))
            _create_scenes_bulk(project_id, scenes)
            
        elif step == "image_gen":
            _generate_all_images(project_id)  # é€åœºæ™¯,æ¯å®Œæˆä¸€ä¸ªæ¨é€è¿›åº¦
            
        elif step == "tts":
            _generate_all_audio(project_id)
            
        elif step == "video_gen":
            _generate_all_videos(project_id)  # ä½¿ç”¨ FFmpeg fallback åŠ é€Ÿ
            
        elif step == "compose":
            compose_final_video(project_id, scene_paths)
    
    _update_project_status(project_id, ProjectStatus.COMPLETED)
    _publish_progress(project_id, "done", len(steps), len(steps), "é¢„è§ˆå®Œæˆ!")
```

å…³é”®è®¾è®¡å†³ç­–:
- Quick Draft æ¨¡å¼ä¸‹**è·³è¿‡æ‰€æœ‰äººå·¥å®¡æ ¸**,è‡ªåŠ¨æ¨è¿›
- å›¾ç‰‡ç”Ÿæˆä½¿ç”¨**ä½åˆ†è¾¨ç‡**(512x512 è€Œé 1024x1024)åŠ é€Ÿ
- è§†é¢‘ç”Ÿæˆä¼˜å…ˆä½¿ç”¨ **FFmpeg fallback**(é™æ€å›¾ + Ken Burns æ•ˆæœ)è€Œéç­‰å¾… Seedance I2V
- åˆæˆåé¡¹ç›®çŠ¶æ€è®¾ä¸º `COMPLETED`,ä½†æ ‡è®°ä¸º `QUICK_DRAFT` æ¨¡å¼
- ç”¨æˆ·å¯ä»¥éšæ—¶ä» Quick Draft åˆ‡æ¢åˆ° Standard æ¨¡å¼è¿›è¡Œç²¾ä¿®

#### API ç«¯ç‚¹

```
[NEW] backend/app/api/quick_draft.py

POST /api/quick-draft
  Body: { "title": "...", "logline": "..." }
  Response: { "project_id": "...", "task_id": "..." }
  
GET /api/quick-draft/{project_id}/progress
  Response: { "step": "image_gen", "current": 3, "total": 5, "desc": "ç»˜åˆ¶ç”»é¢..." }
```

#### å‰ç«¯ç»„ä»¶

```
[MODIFY] frontend/src/app/page.tsx
[NEW] frontend/src/components/QuickDraftWizard.tsx
```

- é¦–é¡µæ–°å¢ "âš¡ ä¸€é”®é¢„è§ˆ" æŒ‰é’®(ä¸"åˆ›å»ºé¡¹ç›®"å¹¶åˆ—)
- `QuickDraftWizard` ç»„ä»¶: å…¨å±å¯¹è¯æ¡†,æ˜¾ç¤ºæ­¥éª¤è¿›åº¦æ¡(7 æ­¥)+ å®æ—¶æ—¥å¿—
- æ¯ä¸€æ­¥å®Œæˆæ—¶æ˜¾ç¤ºä¸­é—´äº§ç‰©é¢„è§ˆ(å¤§çº²æ–‡æœ¬ã€åˆ†é•œåˆ—è¡¨ã€å›¾ç‰‡ç¼©ç•¥å›¾...)
- æœ€ç»ˆå®Œæˆæ—¶è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…é¡µ,æ˜¾ç¤ºåˆæˆè§†é¢‘

#### è¿›åº¦æ¨é€

é€šè¿‡å·²æœ‰çš„ Redis Pub/Sub é€šé“æ¨é€:
```json
{
  "type": "draft_progress",
  "step": "image_gen",
  "current": 3,
  "total": 5,
  "desc": "æ­£åœ¨ä¸ºç¬¬ 3/5 ä¸ªåœºæ™¯ç»˜åˆ¶ç”»é¢...",
  "preview_url": "/media/proj_id/images/scene_3.png"
}
```

---

## æ–¹å‘äºŒ [P0]: è§’è‰²ä¸€è‡´æ€§ç®¡ç†ç³»ç»Ÿ

### ç›®æ ‡
åœ¨ç”Ÿæˆåœºæ™¯å›¾ç‰‡å‰,ä¸ºæ¯ä¸ªè§’è‰²å»ºç«‹è§†è§‰é”šå®šå‚è€ƒ(Reference Sheet),ç¡®ä¿å¤šåœºæ™¯ä¸­åŒä¸€è§’è‰²å¤–è§‚ä¸€è‡´ã€‚

### ç°çŠ¶åˆ†æ
- `Character` æ¨¡å‹æœ‰ `nano_identity_refs` å­—æ®µä½†å®é™…æœªä½¿ç”¨
- `image_gen.py` æ”¯æŒä¼ å…¥ `identity_refs` å‚æ•°ä½†æ²¡æœ‰æœ‰æ•ˆåˆ©ç”¨
- Gemini 2.5 Flash ä¸æ”¯æŒ IP-Adapter çº§åˆ«çš„è§’è‰²ä¸€è‡´æ€§

### è¯¦ç»†è®¾è®¡

#### æ•°æ®æ¨¡å‹å˜æ›´

```python
# [MODIFY] backend/app/models/character.py
class Character(Base):
    # æ–°å¢å­—æ®µ
    reference_image_path: Mapped[Optional[str]] = mapped_column(
        String(1024), nullable=True
    )  # è§’è‰²æ ‡å‡†æ­£é¢å‚è€ƒå›¾è·¯å¾„
    
    style_tags: Mapped[Optional[str]] = mapped_column(
        Text, nullable=True
    )  # JSON: ["é»‘è‰²é•¿å‘", "è“è‰²æ ¡æœ", "èº«é«˜165cm"]
    
    # å¢å¼º appearance_prompt çš„ä½¿ç”¨
    # appearance_prompt ç°åœ¨ä½œä¸º"è§’è‰²å¤–è§‚ prompt æ¨¡æ¿"
    # è‡ªåŠ¨æ³¨å…¥åˆ°æ¯ä¸ªåŒ…å«è¯¥è§’è‰²çš„åœºæ™¯çš„ visual prompt ä¸­
```

#### è§’è‰²å‚è€ƒå›¾ç”ŸæˆæœåŠ¡

```
[NEW] backend/app/services/character_ref_gen.py
```

è®¾è®¡:
```python
async def generate_character_reference(
    character_name: str,
    appearance_prompt: str,
    style_preset: str = "manga",
) -> str:
    """ä¸ºè§’è‰²ç”Ÿæˆä¸€å¼ æ ‡å‡†æ­£é¢å‚è€ƒå›¾(turn-around sheet é£æ ¼)ã€‚
    
    Prompt ç­–ç•¥:
    1. ä½¿ç”¨"character design sheet"å‰ç¼€å¼•å¯¼æ¨¡å‹ç”Ÿæˆè®¾è®¡ç¨¿é£æ ¼
    2. å¼ºè°ƒ"frontal view, white background, full body"
    3. åŒ…å«è§’è‰²çš„æ‰€æœ‰è§†è§‰ç‰¹å¾(å‘å‹ã€æœè£…ã€é…é¥°ç­‰)
    4. è¾“å‡º 1024x1024 é«˜åˆ†è¾¨ç‡å‚è€ƒå›¾
    """
    
    design_prompt = f"""Character design sheet for a comic drama:
Character Name: {character_name}
Visual Description: {appearance_prompt}

Style: {style_preset} style illustration
Requirements:
- Clean frontal view on white/simple background
- Full body visible, showing outfit and key features
- Consistent proportions and art style
- Expression neutral for reference purposes
- High detail on face, hair, and clothing"""
    
    # è°ƒç”¨ image_gen ç”Ÿæˆ
    rel_path = await generate_image(
        prompt=design_prompt,
        project_id=project_id,
        scene_id=f"char_ref_{character_id}",
    )
    return rel_path
```

#### è§’è‰²æ³¨å…¥åˆ°åœºæ™¯ Prompt

```
[MODIFY] backend/app/services/image_gen.py
```

åœ¨ç”Ÿæˆåœºæ™¯å›¾ç‰‡æ—¶,è‡ªåŠ¨å°†è§’è‰²å¤–è§‚æè¿°æ³¨å…¥ prompt:

```python
async def generate_image(prompt_visual, project_id, scene_id, ...):
    # æ–°å¢: è§’è‰²å¤–è§‚æ³¨å…¥
    if character_descriptions:
        char_context = "\n".join([
            f"[Character: {c['name']}] {c['appearance_prompt']}"
            for c in character_descriptions
        ])
        enhanced_prompt = (
            f"IMPORTANT - Character Consistency Rules:\n{char_context}\n\n"
            f"Scene Description:\n{prompt_visual}"
        )
    
    # æ–°å¢: å¦‚æœæœ‰è§’è‰²å‚è€ƒå›¾, ä½œä¸º image input ä¼ ç»™å¤šæ¨¡æ€æ¨¡å‹
    if identity_refs:
        messages.insert(0, {
            "role": "user",
            "content": [
                {"type": "text", "text": "These are the reference images of characters. Maintain exact visual consistency:"},
                *[{"type": "image_url", "image_url": {"url": ref}} for ref in identity_refs]
            ]
        })
```

#### API ç«¯ç‚¹

```
[MODIFY] backend/app/api/characters.py

POST /api/characters/{char_id}/generate-reference
  Response: { "character_id": "...", "reference_image_path": "..." }

POST /api/characters/{char_id}/upload-reference
  Body: multipart/form-data (image file)
  Response: { "character_id": "...", "reference_image_path": "..." }
```

#### å‰ç«¯ç»„ä»¶

```
[NEW] frontend/src/components/CharacterDesigner.tsx
```

- åœ¨ `OUTLINE_REVIEW` é˜¶æ®µåæ–°å¢"è§’è‰²è®¾è®¡"æ­¥éª¤
- å¡ç‰‡å¼æ˜¾ç¤ºæ¯ä¸ªè§’è‰²:åå­— + å¤–è§‚æè¿° + å‚è€ƒå›¾(å¦‚å·²ç”Ÿæˆ)
- æ”¯æŒæ“ä½œ: "AI ç”Ÿæˆå‚è€ƒå›¾" / "æ‰‹åŠ¨ä¸Šä¼ å‚è€ƒå›¾" / "é‡æ–°ç”Ÿæˆ"
- ç¡®è®¤æ‰€æœ‰è§’è‰²åæ‰èƒ½è¿›å…¥åˆ†é•œé˜¶æ®µ

#### å·¥ä½œæµå˜æ›´

```
ç°æœ‰: å¤§çº² â†’ å‰§æœ¬ â†’ åˆ†é•œ â†’ å›¾ç‰‡ç”Ÿæˆ
è°ƒæ•´: å¤§çº² â†’ è§’è‰²è®¾è®¡(NEW) â†’ å‰§æœ¬ â†’ åˆ†é•œ â†’ å›¾ç‰‡ç”Ÿæˆ(å¸¦è§’è‰²å‚è€ƒ)
```

éœ€è¦åœ¨ `ProjectStatus` ä¸­æ–°å¢ `CHARACTER_DESIGN` çŠ¶æ€:

```python
class ProjectStatus(str, enum.Enum):
    DRAFT = "DRAFT"
    OUTLINE_REVIEW = "OUTLINE_REVIEW"
    CHARACTER_DESIGN = "CHARACTER_DESIGN"   # [NEW]
    SCRIPT_REVIEW = "SCRIPT_REVIEW"
    STORYBOARD = "STORYBOARD"
    PRODUCTION = "PRODUCTION"
    COMPOSING = "COMPOSING"
    COMPLETED = "COMPLETED"
```

---

## æ–¹å‘ä¸‰ [P2]: è§†é¢‘ç”Ÿæˆè´¨é‡ä¸å¤š Provider ç­–ç•¥

### ç›®æ ‡
è§£å†³è§†é¢‘æ—¶é•¿ä¸è¶³ã€è´¨é‡ä¸ç¨³å®šã€å•ä¸€ Provider é£é™©,å»ºç«‹å¤šæº failover ä½“ç³»ã€‚

### è¯¦ç»†è®¾è®¡

#### Provider æŠ½è±¡å±‚

```
[NEW] backend/app/services/video_providers/__init__.py
[NEW] backend/app/services/video_providers/base.py
[NEW] backend/app/services/video_providers/seedance.py
[NEW] backend/app/services/video_providers/kling.py
[NEW] backend/app/services/video_providers/ffmpeg_fallback.py
```

```python
# base.py
from abc import ABC, abstractmethod
from dataclasses import dataclass

@dataclass
class VideoGenResult:
    local_path: str
    duration_seconds: float
    provider: str
    cost_estimate: float  # é¢„ä¼°æˆæœ¬(ç¾å…ƒ)
    quality_score: float  # 0-1 è‡ªè¯„åˆ†

class VideoProvider(ABC):
    name: str
    priority: int  # è¶Šä½è¶Šä¼˜å…ˆ
    max_duration: float  # è¯¥ provider æ”¯æŒçš„æœ€å¤§æ—¶é•¿
    
    @abstractmethod
    async def generate(
        self,
        image_path: str,
        motion_prompt: str,
        target_duration: float,
        audio_path: str | None = None,
    ) -> VideoGenResult:
        ...
    
    @abstractmethod
    async def check_availability(self) -> bool:
        """æ£€æŸ¥ API æ˜¯å¦å¯ç”¨(ä½™é¢ã€é™æµç­‰)"""
        ...
```

```python
# seedance.py
class SeedanceProvider(VideoProvider):
    name = "seedance"
    priority = 1
    max_duration = 5.0
    
    async def generate(self, image_path, motion_prompt, target_duration, audio_path=None):
        # ç°æœ‰ Seedance é€»è¾‘
        # å¦‚æœ target_duration > 5s, ç”Ÿæˆå¤šæ®µå¹¶æ‹¼æ¥
        segments = math.ceil(target_duration / self.max_duration)
        ...
```

```python
# kling.py (ç¤ºä¾‹: å¯çµ API)
class KlingProvider(VideoProvider):
    name = "kling"
    priority = 2
    max_duration = 10.0
    
    async def generate(self, ...):
        # å¯çµ API è°ƒç”¨é€»è¾‘
        ...
```

#### è§†é¢‘æ—¶é•¿ç­–ç•¥

```
[MODIFY] backend/app/services/video_gen.py
```

```python
def calculate_target_duration(dialogue_text: str, audio_path: str | None) -> float:
    """æ ¹æ®å¯¹ç™½å†…å®¹è®¡ç®—ç›®æ ‡è§†é¢‘æ—¶é•¿"""
    if audio_path:
        # æœ‰éŸ³é¢‘: è§†é¢‘æ—¶é•¿ = éŸ³é¢‘æ—¶é•¿ + 1ç§’å‰åç¼“å†²
        audio_duration = get_audio_duration(audio_path)
        return audio_duration + 2.0
    elif dialogue_text:
        # æ— éŸ³é¢‘ä½†æœ‰å¯¹ç™½: æŒ‰ä¸­æ–‡è¯­é€Ÿä¼°ç®— (4å­—/ç§’)
        char_count = len(dialogue_text)
        return max(3.0, char_count / 4.0 + 2.0)
    else:
        # æ— å¯¹ç™½: é»˜è®¤ 4 ç§’
        return 4.0

async def generate_video_with_strategy(
    prompt_motion: str,
    project_id: str,
    scene_id: str,
    image_path: str,
    audio_path: str | None = None,
    dialogue_text: str | None = None,
) -> str:
    """å¸¦ç­–ç•¥çš„è§†é¢‘ç”Ÿæˆï¼šè‡ªåŠ¨é€‰æ‹© Providerã€è®¡ç®—æ—¶é•¿ã€å¤šæ®µæ‹¼æ¥"""
    target_duration = calculate_target_duration(dialogue_text, audio_path)
    
    # æŒ‰ä¼˜å…ˆçº§å°è¯• providers
    for provider in sorted(providers, key=lambda p: p.priority):
        if not await provider.check_availability():
            continue
        try:
            result = await provider.generate(
                image_path, prompt_motion, target_duration, audio_path
            )
            logger.info("Video generated via %s: %ss, cost=$%.4f",
                       result.provider, result.duration_seconds, result.cost_estimate)
            return result.local_path
        except Exception as e:
            logger.warning("Provider %s failed: %s, trying next...", provider.name, e)
    
    # æ‰€æœ‰ provider å¤±è´¥ï¼Œä½¿ç”¨ FFmpeg Ken Burns
    return await ffmpeg_fallback.generate(image_path, prompt_motion, target_duration, audio_path)
```

#### FFmpeg Ken Burns å¢å¼º

```
[MODIFY] backend/app/services/ffmpeg_service.py
```

```python
def create_ken_burns_video(image_path: str, duration: float, output_path: str):
    """ç”¨ Ken Burns æ•ˆæœ(ç¼“æ…¢ç¼©æ”¾/å¹³ç§»)æŠŠé™æ€å›¾è½¬ä¸ºæ›´æœ‰åŠ¨æ„Ÿçš„è§†é¢‘"""
    # ffmpeg -loop 1 -i image.png -vf "zoompan=z='1.04':d=125:s=1024x1024" 
    #        -t {duration} -c:v libx264 -pix_fmt yuv420p output.mp4
    
    zoom_filter = (
        f"zoompan=z='min(zoom+0.0008,1.5)':x='iw/2-(iw/zoom/2)':"
        f"y='ih/2-(ih/zoom/2)':d={int(duration*25)}:s=1024x1024:fps=25"
    )
    ...
```

#### é…ç½®

```python
# [MODIFY] backend/app/config.py
class Settings(BaseModel):
    # è§†é¢‘ç”Ÿæˆç­–ç•¥
    VIDEO_PROVIDERS: list[str] = ["seedance", "ffmpeg"]  # æŒ‰ä¼˜å…ˆçº§æ’åˆ—
    KLING_API_KEY: str = ""
    KLING_ENDPOINT: str = "https://api.klingai.com/v1"
```

---

## æ–¹å‘å›› [P1]: ç´ æç‰ˆæœ¬ç®¡ç†

### ç›®æ ‡
æ”¯æŒç´ æå¤šç‰ˆæœ¬å­˜å‚¨ã€å›æ»šã€A/B å¯¹æ¯”ã€‚

### è¯¦ç»†è®¾è®¡

#### æ•°æ®æ¨¡å‹

```
[NEW] backend/app/models/asset_version.py
```

```python
class AssetType(str, enum.Enum):
    IMAGE = "IMAGE"
    AUDIO = "AUDIO"
    VIDEO = "VIDEO"

class AssetVersion(Base):
    """ä¸€ä¸ªåœºæ™¯çš„æŸç±»ç´ æçš„ä¸€ä¸ªç‰ˆæœ¬"""
    __tablename__ = "asset_versions"
    
    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=...)
    scene_id: Mapped[str] = mapped_column(String(36), ForeignKey("scenes.id"), index=True)
    asset_type: Mapped[str] = mapped_column(String(20), nullable=False)  # IMAGE/AUDIO/VIDEO
    version: Mapped[int] = mapped_column(Integer, nullable=False, default=1)
    local_path: Mapped[str] = mapped_column(String(1024), nullable=False)
    prompt_used: Mapped[Optional[str]] = mapped_column(Text, nullable=True)  # ç”Ÿæˆæ—¶ä½¿ç”¨çš„ prompt
    provider: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)  # seedance/kling/ffmpeg
    is_selected: Mapped[bool] = mapped_column(default=False)  # å½“å‰é€‰ä¸­çš„ç‰ˆæœ¬
    quality_score: Mapped[Optional[float]] = mapped_column(nullable=True)  # VLM è¯„åˆ†
    created_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.now())
    
    # Relationships
    scene = relationship("Scene", back_populates="asset_versions")
```

```python
# [MODIFY] backend/app/models/scene.py
class Scene(Base):
    # æ–°å¢å…³ç³»
    asset_versions = relationship("AssetVersion", back_populates="scene", 
                                   cascade="all, delete-orphan")
```

#### ç‰ˆæœ¬ç®¡ç†é€»è¾‘

```
[MODIFY] backend/app/tasks/asset_tasks.py
```

ç”Ÿæˆæ–°ç´ ææ—¶,ä¸å†ç›´æ¥è¦†ç›– Scene çš„ path å­—æ®µ,è€Œæ˜¯:
1. åˆ›å»ºæ–°çš„ `AssetVersion` è®°å½•
2. å°†æ–°ç‰ˆæœ¬æ ‡è®°ä¸º `is_selected=True`
3. æ—§ç‰ˆæœ¬ `is_selected=False`(ä½†ä¿ç•™æ–‡ä»¶)
4. æ›´æ–° Scene çš„ `local_xxx_path` æŒ‡å‘æœ€æ–°é€‰ä¸­ç‰ˆæœ¬

```python
async def _save_asset_version(
    scene_id: str, 
    asset_type: AssetType, 
    local_path: str,
    prompt_used: str | None = None,
    provider: str | None = None,
) -> AssetVersion:
    """ä¿å­˜æ–°çš„ç´ æç‰ˆæœ¬å¹¶è®¾ä¸ºå½“å‰é€‰ä¸­"""
    async with async_session_factory() as session:
        # å–æ¶ˆæ—§ç‰ˆæœ¬çš„ selected çŠ¶æ€
        await session.execute(
            update(AssetVersion)
            .where(AssetVersion.scene_id == scene_id, AssetVersion.asset_type == asset_type)
            .values(is_selected=False)
        )
        # è·å–æœ€æ–°ç‰ˆæœ¬å·
        result = await session.execute(
            select(func.max(AssetVersion.version))
            .where(AssetVersion.scene_id == scene_id, AssetVersion.asset_type == asset_type)
        )
        max_version = result.scalar() or 0
        
        # åˆ›å»ºæ–°ç‰ˆæœ¬
        new_version = AssetVersion(
            scene_id=scene_id,
            asset_type=asset_type.value,
            version=max_version + 1,
            local_path=local_path,
            prompt_used=prompt_used,
            provider=provider,
            is_selected=True,
        )
        session.add(new_version)
        await session.commit()
        return new_version
```

#### API ç«¯ç‚¹

```
[MODIFY] backend/app/api/assets.py

GET /api/scenes/{scene_id}/versions
  Response: { "versions": [{ "id": "...", "type": "IMAGE", "version": 2, ... }] }

POST /api/scenes/{scene_id}/versions/{version_id}/select
  Response: { "selected_version": 2 }
  
POST /api/scenes/{scene_id}/versions/{version_id}/delete
```

#### å‰ç«¯

```
[MODIFY] frontend/src/components/SceneCard.tsx
```

- å›¾ç‰‡/è§†é¢‘é¢„è§ˆåŒºåŸŸæ–°å¢ "ç‰ˆæœ¬" ä¸‹æ‹‰é€‰æ‹©å™¨
- æ˜¾ç¤ºç‰ˆæœ¬å· + ç”Ÿæˆæ—¶é—´ + è¯„åˆ†(å¦‚æœ‰)
- æ”¯æŒå·¦å³ç®­å¤´å¿«é€Ÿåˆ‡æ¢ç‰ˆæœ¬å¯¹æ¯”

---

## æ–¹å‘äº” [P1]: Prompt å¤–ç½® + é£æ ¼é¢„è®¾

### ç›®æ ‡
å°†æ‰€æœ‰ AI prompt æ¨¡æ¿ä» Python ä»£ç ä¸­æŠ½ç¦»,æ”¯æŒçƒ­æ›´æ–°å’Œé£æ ¼åˆ‡æ¢ã€‚

### è¯¦ç»†è®¾è®¡

#### Prompt æ¨¡æ¿å­˜å‚¨

```
[NEW] backend/app/prompts/
         â”œâ”€â”€ __init__.py
         â”œâ”€â”€ manager.py           # Prompt åŠ è½½ä¸ç®¡ç†
         â””â”€â”€ templates/
              â”œâ”€â”€ default/
              â”‚    â”œâ”€â”€ outline.txt
              â”‚    â”œâ”€â”€ script.txt
              â”‚    â”œâ”€â”€ parse_scenes.txt
              â”‚    â”œâ”€â”€ visual_prompt_enhance.txt
              â”‚    â””â”€â”€ motion_prompt.txt
              â”œâ”€â”€ manga_jp/         # æ—¥æ¼«é£é¢„è®¾
              â”‚    â”œâ”€â”€ outline.txt
              â”‚    â””â”€â”€ ...
              â”œâ”€â”€ manga_cn/         # å›½æ¼«é£é¢„è®¾
              â”‚    â”œâ”€â”€ outline.txt
              â”‚    â””â”€â”€ ...
              â””â”€â”€ comic_us/         # ç¾æ¼«é£é¢„è®¾
                   â””â”€â”€ ...
```

```python
# manager.py
class PromptManager:
    """Prompt æ¨¡æ¿ç®¡ç†å™¨ â€” ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½,æ”¯æŒé£æ ¼é¢„è®¾"""
    
    _cache: dict[str, dict[str, str]] = {}
    
    @classmethod
    def get_prompt(cls, template_name: str, style: str = "default") -> str:
        """è·å–æŒ‡å®šé£æ ¼çš„ prompt æ¨¡æ¿"""
        cache_key = f"{style}/{template_name}"
        if cache_key not in cls._cache:
            path = Path(__file__).parent / "templates" / style / f"{template_name}.txt"
            if not path.exists():
                # Fallback to default style
                path = Path(__file__).parent / "templates" / "default" / f"{template_name}.txt"
            cls._cache[cache_key] = path.read_text(encoding="utf-8")
        return cls._cache[cache_key]
    
    @classmethod
    def reload(cls):
        """æ¸…é™¤ç¼“å­˜,é‡æ–°åŠ è½½(çƒ­æ›´æ–°)"""
        cls._cache.clear()
    
    @classmethod
    def list_styles(cls) -> list[str]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„é£æ ¼é¢„è®¾"""
        templates_dir = Path(__file__).parent / "templates"
        return [d.name for d in templates_dir.iterdir() if d.is_dir()]
```

#### æ•°æ®æ¨¡å‹å˜æ›´

```python
# [MODIFY] backend/app/models/project.py
class Project(Base):
    style_preset: Mapped[str] = mapped_column(
        String(50), nullable=False, default="default"
    )  # é£æ ¼é¢„è®¾åç§°: "default", "manga_jp", "manga_cn", "comic_us"
```

#### æœåŠ¡é›†æˆ

```
[MODIFY] backend/app/services/ai_writer.py
```

```python
# æ›¿æ¢ç¡¬ç¼–ç  prompt
async def generate_outline(logline: str, style: str = "default") -> str:
    system_prompt = PromptManager.get_prompt("outline", style)
    return await _call_openrouter(system_prompt=system_prompt, user_prompt=f"çµæ„Ÿï¼š{logline}")
```

```
[MODIFY] backend/app/services/image_gen.py
```

```python
# visual prompt ä¹ŸæŒ‰é£æ ¼æ³¨å…¥ä¸åŒçš„è‰ºæœ¯æŒ‡å¯¼
async def generate_image(prompt_visual, ..., style="default"):
    style_guide = PromptManager.get_prompt("visual_prompt_enhance", style)
    enhanced_prompt = f"{style_guide}\n\n{prompt_visual}"
```

#### API ç«¯ç‚¹

```
[NEW] backend/app/api/styles.py

GET /api/styles
  Response: { "styles": ["default", "manga_jp", "manga_cn", "comic_us"] }
  
GET /api/styles/{style_name}/preview
  Response: { "name": "manga_jp", "description": "...", "preview_image": "..." }
  
POST /api/prompts/reload
  Response: { "reloaded": true }  # ç®¡ç†å‘˜çƒ­æ›´æ–°
```

#### å‰ç«¯

```
[MODIFY] frontend/src/app/page.tsx (åˆ›å»ºé¡¹ç›®æ—¶é€‰æ‹©é£æ ¼)
[NEW] frontend/src/components/StylePicker.tsx
```

- åˆ›å»ºé¡¹ç›®å¯¹è¯æ¡†æ–°å¢"é£æ ¼é€‰æ‹©"æ­¥éª¤
- å¡ç‰‡å¼å±•ç¤ºå„é£æ ¼é¢„è®¾:é¢„è§ˆå›¾ + é£æ ¼å + ç®€çŸ­æè¿°
- é»˜è®¤é€‰ä¸­ "default" é£æ ¼

---

## æ–¹å‘å…­ [P2]: VLM è‡ªåŠ¨è¯„åˆ†

### ç›®æ ‡
ç”Ÿæˆç´ æåè‡ªåŠ¨è¯„ä¼°è´¨é‡,ä½äºé˜ˆå€¼è‡ªåŠ¨é‡è¯•,å‡å°‘äººå·¥å®¡æ ¸è´Ÿæ‹…ã€‚

### è¯¦ç»†è®¾è®¡

#### è¯„åˆ†æœåŠ¡

```
[NEW] backend/app/services/quality_scorer.py
```

```python
@dataclass
class QualityScore:
    overall: float         # 0-1 ç»¼åˆåˆ†
    composition: float     # æ„å›¾è´¨é‡
    prompt_adherence: float  # ä¸ prompt çš„åŒ¹é…åº¦
    character_consistency: float  # è§’è‰²ä¸€è‡´æ€§
    technical_quality: float     # æŠ€æœ¯è´¨é‡(æ¸…æ™°åº¦ã€æ— ä¼ªå½±)
    reasons: list[str]     # æ‰£åˆ†åŸå› 

async def score_image(
    image_path: str,
    original_prompt: str,
    character_refs: list[str] | None = None,
) -> QualityScore:
    """ä½¿ç”¨ VLM å¯¹ç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œè´¨é‡è¯„åˆ†"""
    
    scoring_prompt = f"""You are an expert comic art director evaluating a generated image.
    
Original prompt: {original_prompt}

Score the image on these dimensions (0-10 each):
1. composition: Layout, framing, visual balance
2. prompt_adherence: How well it matches the requested scene
3. character_consistency: Character appearance consistency with references
4. technical_quality: Clarity, no artifacts, proper anatomy

Respond in JSON:
{{"composition": N, "prompt_adherence": N, "character_consistency": N, 
  "technical_quality": N, "reasons": ["reason1", "reason2"]}}"""
    
    # è°ƒç”¨ VLM (Gemini 2.5 Flash with image input)
    messages = [
        {"role": "user", "content": [
            {"type": "text", "text": scoring_prompt},
            {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{img_b64}"}},
        ]}
    ]
    
    if character_refs:
        messages[0]["content"].append(
            {"type": "text", "text": "Character reference images for consistency check:"}
        )
        for ref in character_refs[:2]:  # æœ€å¤šä¼  2 å¼ å‚è€ƒå›¾
            messages[0]["content"].append(
                {"type": "image_url", "image_url": {"url": ref}}
            )
    
    response = await _call_openrouter(messages, json_mode=True)
    scores = json.loads(response)
    
    overall = (
        scores["composition"] * 0.2 +
        scores["prompt_adherence"] * 0.35 +
        scores["character_consistency"] * 0.25 +
        scores["technical_quality"] * 0.2
    ) / 10.0
    
    return QualityScore(
        overall=overall,
        composition=scores["composition"] / 10.0,
        prompt_adherence=scores["prompt_adherence"] / 10.0,
        character_consistency=scores["character_consistency"] / 10.0,
        technical_quality=scores["technical_quality"] / 10.0,
        reasons=scores.get("reasons", []),
    )

async def check_audio_quality(audio_path: str, dialogue_text: str) -> bool:
    """æ£€æŸ¥ TTS éŸ³é¢‘çš„åˆç†æ€§"""
    duration = get_audio_duration(audio_path)
    expected_duration = len(dialogue_text) / 4.0  # ä¸­æ–‡çº¦ 4å­—/ç§’
    
    # æ—¶é•¿åå·®è¶…è¿‡ 3 å€è®¤ä¸ºå¼‚å¸¸
    if duration > expected_duration * 3 or duration < expected_duration * 0.3:
        logger.warning("Audio duration suspect: %.1fs vs expected %.1fs", duration, expected_duration)
        return False
    return True
```

#### é›†æˆåˆ°ç”Ÿæˆæµç¨‹

```
[MODIFY] backend/app/tasks/asset_tasks.py
```

```python
@shared_task(bind=True, max_retries=2)
def generate_scene_image(self, scene_id, project_id, prompt_visual, ...):
    # ... ç°æœ‰ç”Ÿæˆé€»è¾‘ ...
    
    # [NEW] è‡ªåŠ¨è¯„åˆ†
    if settings.ENABLE_AUTO_SCORING:
        score = run_async(score_image(full_image_path, prompt_visual, identity_refs))
        run_async(_save_asset_version(scene_id, AssetType.IMAGE, rel_path,
                                       prompt_used=prompt_visual, quality_score=score.overall))
        
        if score.overall < settings.QUALITY_THRESHOLD:  # é»˜è®¤ 0.6
            logger.warning("Image quality below threshold (%.2f < %.2f): %s",
                          score.overall, settings.QUALITY_THRESHOLD, score.reasons)
            # è‡ªåŠ¨é‡è¯•(ä½¿ç”¨å¢å¼ºç‰ˆ prompt)
            enhanced_prompt = f"[IMPORTANT: Previous attempt had issues: {'; '.join(score.reasons)}]\n{prompt_visual}"
            raise self.retry(exc=Exception(f"Quality too low: {score.overall}"),
                           kwargs={"prompt_visual": enhanced_prompt})
```

#### é…ç½®

```python
# [MODIFY] backend/app/config.py
class Settings(BaseModel):
    ENABLE_AUTO_SCORING: bool = True
    QUALITY_THRESHOLD: float = 0.6  # ä½äºæ­¤åˆ†æ•°è‡ªåŠ¨é‡è¯•
    MAX_QUALITY_RETRIES: int = 2
```

---

## æ–¹å‘ä¸ƒ [P2]: å‰ç«¯äº¤äº’ä½“éªŒæå‡

### ç›®æ ‡
å®æ—¶è¿›åº¦æ¡ã€æ‰¹é‡æ“ä½œã€æ‹–æ‹½åé¦ˆã€before/after å¯¹æ¯”ã€‚

### è¯¦ç»†è®¾è®¡

#### å®æ—¶è¿›åº¦æ¡

```
[NEW] frontend/src/components/ProgressBar.tsx
```

```typescript
interface ProgressBarProps {
  projectId: string;
  visible: boolean;
}

// é€šè¿‡ WebSocket æ¥æ”¶è¿›åº¦æ›´æ–°
// æ˜¾ç¤º: [Step Icon] æ­¥éª¤å  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 60%  "æ­£åœ¨ä¸ºç¬¬ 3/5 ä¸ªåœºæ™¯ç»˜åˆ¶ç”»é¢..."
// æ¯ä¸ªæ­¥éª¤ç”¨ä¸åŒé¢œè‰²çš„ icon åŒºåˆ†
```

#### æ‰¹é‡å®¡æ ¸

```
[MODIFY] frontend/src/components/KanbanBoard.tsx
```

- åœ¨ REVIEW åˆ—ä¸Šæ–¹æ–°å¢: "âœ… å…¨éƒ¨é€šè¿‡" / "ğŸ”„ å…¨éƒ¨é‡æ–°ç”Ÿæˆ" æŒ‰é’®
- é€‰ä¸­æ¨¡å¼: æ”¯æŒå¤šé€‰ scene card,ç„¶åæ‰¹é‡æ“ä½œ

```
[NEW] backend/app/api/assets.py

POST /api/batch-approve
  Body: { "scene_ids": ["id1", "id2", "id3"] }
  Response: { "approved": 3, "tasks": [...] }
```

#### Toast é€šçŸ¥ç³»ç»Ÿ

```
[NEW] frontend/src/components/Toast.tsx
[NEW] frontend/src/stores/useToastStore.ts
```

```typescript
interface Toast {
  id: string;
  type: "success" | "error" | "info" | "warning";
  message: string;
  duration?: number;  // è‡ªåŠ¨æ¶ˆå¤±æ—¶é—´, é»˜è®¤ 3000ms
}

// å…¨å±€ toast ç®¡ç†å™¨, åœ¨ layout.tsx ä¸­æ¸²æŸ“
// æ‹–æ‹½æ’åºå: showToast("success", "åœºæ™¯é¡ºåºå·²ä¿å­˜")
// æ‰¹é‡å®¡æ ¸å: showToast("success", "3 ä¸ªåœºæ™¯å·²é€šè¿‡å®¡æ ¸")
```

#### Before/After å¯¹æ¯”è§†å›¾

```
[NEW] frontend/src/components/CompareView.tsx
```

- ä¸€ä¸ªå¯æ‹–åŠ¨åˆ†å‰²çº¿çš„å åŠ è§†å›¾
- å·¦ä¾§: æ—§ç‰ˆç´ æ | å³ä¾§: æ–°ç‰ˆç´ æ
- æ”¯æŒå¯¹æ¯”: å›¾ç‰‡ vs å›¾ç‰‡, è‡ªåŠ¨æ’­æ”¾ä¸¤æ®µè§†é¢‘

---

## æ–¹å‘å…« [P1]: ä»»åŠ¡ DAG ç¼–æ’

### ç›®æ ‡
ç”¨ Celery Canvas å£°æ˜å¼ç¼–æ’æ•´ä¸ªèµ„äº§ç”Ÿæˆæµç¨‹,æ›¿ä»£ API å±‚æ‰‹åŠ¨ dispatchã€‚

### è¯¦ç»†è®¾è®¡

#### ç¼–æ’æœåŠ¡

```
[NEW] backend/app/services/pipeline_orchestrator.py
```

```python
from celery import chain, chord, group
from app.tasks.asset_tasks import generate_scene_audio, generate_scene_image, generate_scene_video
from app.tasks.compose_task import compose_project_video

def build_production_pipeline(project_id: str, scenes: list[dict]) -> celery.Signature:
    """æ„å»ºå®Œæ•´çš„ç”Ÿäº§æµæ°´çº¿ DAG"""
    
    scene_pipelines = []
    for scene in scenes:
        # æ¯ä¸ª scene: audio å’Œ image å¹¶è¡Œï¼Œä¸¤è€…éƒ½å®Œæˆåæ ‡è®°ä¸º REVIEW
        asset_gen = chord(
            group(
                generate_scene_audio.s(scene["id"], project_id, scene["dialogue_text"]),
                generate_scene_image.s(scene["id"], project_id, scene["prompt_visual"],
                                       scene["sfx_text"], scene.get("identity_refs")),
            ),
            mark_scene_reviewable.s(scene["id"])  # callback: æ ‡è®°åœºæ™¯å¯å®¡æ ¸
        )
        scene_pipelines.append(asset_gen)
    
    # æ‰€æœ‰åœºæ™¯å¹¶è¡Œç”Ÿæˆ
    return group(scene_pipelines)

def build_video_pipeline(project_id: str, approved_scenes: list[dict]) -> celery.Signature:
    """å®¡æ ¸é€šè¿‡å: æ‰€æœ‰åœºæ™¯è§†é¢‘å¹¶è¡Œç”Ÿæˆ â†’ åˆæˆ"""
    video_gen_tasks = group(
        generate_scene_video.s(
            scene["id"], project_id, scene["prompt_motion"],
            scene["local_image_path"], scene["local_audio_path"]
        )
        for scene in approved_scenes
    )
    
    # chord: æ‰€æœ‰è§†é¢‘å®Œæˆåè‡ªåŠ¨è§¦å‘ compose
    return chord(video_gen_tasks, compose_project_video.s(project_id))
```

#### çŠ¶æ€å›è°ƒ

```
[NEW] backend/app/tasks/pipeline_callbacks.py
```

```python
@shared_task
def mark_scene_reviewable(results, scene_id: str):
    """chord callback: å½“ audio + image éƒ½å®Œæˆæ—¶,æ ‡è®° scene ä¸º REVIEW"""
    # results åŒ…å« [audio_result, image_result]
    run_async(_update_scene_status(scene_id, SceneStatus.REVIEW.value))
    # å¦‚æœé¡¹ç›®ä¸‹æ‰€æœ‰ scene éƒ½åˆ° REVIEW,é€šçŸ¥å‰ç«¯å¯ä»¥æ‰¹é‡å®¡æ ¸
    run_async(_check_all_scenes_reviewable(scene_id))
```

#### API é›†æˆ

```
[MODIFY] backend/app/api/assets.py
```

```python
@router.post("/generate-all-images")
async def generate_all_scene_images(req, db):
    # æ›¿æ¢æ‰‹åŠ¨ dispatch ä¸º pipeline orchestrator
    from app.services.pipeline_orchestrator import build_production_pipeline
    
    pipeline = build_production_pipeline(req.project_id, scene_data_list)
    result = pipeline.apply_async()
    
    return {"pipeline_id": result.id, "total_scenes": len(scene_data_list)}
```

---

## æ–¹å‘ä¹ [P3]: ç»Ÿä¸€ GenerationService åŸºç±»

### ç›®æ ‡
ä¸ºæ‰€æœ‰ç”ŸæˆæœåŠ¡(AI Writer, Image Gen, Video Gen, TTS)æä¾›ç»Ÿä¸€çš„ retry/fallback/timeout/cost tracking æ¥å£ã€‚

### è¯¦ç»†è®¾è®¡

#### åŸºç±»å®šä¹‰

```
[NEW] backend/app/services/base_gen_service.py
```

```python
from abc import ABC, abstractmethod
from dataclasses import dataclass, field
from typing import TypeVar, Generic
import time

T = TypeVar("T")

@dataclass
class GenResult(Generic[T]):
    """é€šç”¨ç”Ÿæˆç»“æœ"""
    data: T
    provider: str
    latency_ms: int
    cost_estimate: float
    retries_used: int
    fallback_used: bool = False

@dataclass 
class GenServiceConfig:
    """é€šç”¨ç”ŸæˆæœåŠ¡é…ç½®"""
    max_retries: int = 3
    retry_delay: float = 2.0
    timeout: float = 180.0
    fallback_enabled: bool = True

class BaseGenService(ABC, Generic[T]):
    """æ‰€æœ‰ç”ŸæˆæœåŠ¡çš„åŸºç±»"""
    
    service_name: str
    config: GenServiceConfig
    
    def __init__(self, config: GenServiceConfig | None = None):
        self.config = config or GenServiceConfig()
        self._total_calls = 0
        self._total_cost = 0.0
        self._total_errors = 0
    
    async def execute(self, **kwargs) -> GenResult[T]:
        """ç»Ÿä¸€æ‰§è¡Œå…¥å£,å¸¦ retry/fallback/metrics"""
        self._total_calls += 1
        start = time.monotonic()
        last_error = None
        
        for attempt in range(self.config.max_retries + 1):
            try:
                result = await asyncio.wait_for(
                    self._generate(**kwargs),
                    timeout=self.config.timeout,
                )
                latency = int((time.monotonic() - start) * 1000)
                gen_result = GenResult(
                    data=result,
                    provider=self.service_name,
                    latency_ms=latency,
                    cost_estimate=self._estimate_cost(**kwargs),
                    retries_used=attempt,
                )
                self._total_cost += gen_result.cost_estimate
                return gen_result
                
            except Exception as e:
                last_error = e
                self._total_errors += 1
                logger.warning("%s attempt %d failed: %s", self.service_name, attempt+1, e)
                if attempt < self.config.max_retries:
                    await asyncio.sleep(self.config.retry_delay * (attempt + 1))
        
        # æ‰€æœ‰é‡è¯•å¤±è´¥,å°è¯• fallback
        if self.config.fallback_enabled:
            try:
                result = await self._fallback(**kwargs)
                latency = int((time.monotonic() - start) * 1000)
                return GenResult(
                    data=result,
                    provider=f"{self.service_name}_fallback",
                    latency_ms=latency,
                    cost_estimate=0.0,
                    retries_used=self.config.max_retries,
                    fallback_used=True,
                )
            except Exception as fb_err:
                logger.error("%s fallback also failed: %s", self.service_name, fb_err)
        
        raise RuntimeError(f"{self.service_name} failed after {self.config.max_retries} retries: {last_error}")
    
    @abstractmethod
    async def _generate(self, **kwargs) -> T:
        """å­ç±»å®ç°å…·ä½“ç”Ÿæˆé€»è¾‘"""
        ...
    
    async def _fallback(self, **kwargs) -> T:
        """å¯é€‰: å­ç±»è¦†å†™ fallback é€»è¾‘"""
        raise NotImplementedError(f"{self.service_name} has no fallback")
    
    def _estimate_cost(self, **kwargs) -> float:
        """å¯é€‰: å­ç±»è¦†å†™æˆæœ¬ä¼°ç®—"""
        return 0.0
    
    def get_metrics(self) -> dict:
        """è¿”å›æœåŠ¡ä½¿ç”¨ç»Ÿè®¡"""
        return {
            "service": self.service_name,
            "total_calls": self._total_calls,
            "total_cost": round(self._total_cost, 4),
            "total_errors": self._total_errors,
            "error_rate": self._total_errors / max(self._total_calls, 1),
        }
```

#### ç°æœ‰æœåŠ¡æ”¹é€ ç¤ºä¾‹

```python
# [MODIFY] backend/app/services/video_gen.py
class VideoGenService(BaseGenService[str]):
    service_name = "video_gen"
    
    async def _generate(self, image_path, motion_prompt, ...) -> str:
        # ç°æœ‰ Seedance é€»è¾‘
        ...
    
    async def _fallback(self, image_path, ...) -> str:
        # FFmpeg Ken Burns fallback
        ...
    
    def _estimate_cost(self, **kwargs) -> float:
        return 0.02  # Seedance per-call estimate
```

#### Metrics API

```
[NEW] backend/app/api/metrics.py

GET /api/metrics/generation
  Response: {
    "services": [
      {"service": "video_gen", "total_calls": 45, "total_cost": 0.90, "error_rate": 0.04},
      {"service": "image_gen", "total_calls": 100, "total_cost": 0.50, "error_rate": 0.02},
      {"service": "tts", "total_calls": 80, "total_cost": 0.00, "error_rate": 0.01},
    ]
  }
```

---

## å®æ–½è·¯çº¿å›¾

```
Week 1 (P0):
â”œâ”€â”€ Quick Draft ä¸€é”®é¢„è§ˆ (#1)
â”‚   â”œâ”€â”€ backend: quick_draft_task.py + API
â”‚   â””â”€â”€ frontend: QuickDraftWizard.tsx
â””â”€â”€ è§’è‰²ä¸€è‡´æ€§ (#2)
    â”œâ”€â”€ backend: character_ref_gen.py + æ¨¡å‹å˜æ›´
    â””â”€â”€ frontend: CharacterDesigner.tsx

Week 2 (P1):
â”œâ”€â”€ Prompt å¤–ç½® + é£æ ¼é¢„è®¾ (#5)
â”‚   â”œâ”€â”€ backend: prompts/ ç›®å½•ç»“æ„ + PromptManager
â”‚   â””â”€â”€ frontend: StylePicker.tsx
â”œâ”€â”€ ç´ æç‰ˆæœ¬ç®¡ç† (#4)
â”‚   â”œâ”€â”€ backend: AssetVersion æ¨¡å‹ + API
â”‚   â””â”€â”€ frontend: SceneCard ç‰ˆæœ¬é€‰æ‹©å™¨
â””â”€â”€ ä»»åŠ¡ DAG ç¼–æ’ (#8)
    â””â”€â”€ backend: pipeline_orchestrator.py + callbacks

Week 3 (P2):
â”œâ”€â”€ å‰ç«¯äº¤äº’å¢å¼º (#7)
â”‚   â”œâ”€â”€ ProgressBar.tsx
â”‚   â”œâ”€â”€ Toast ç³»ç»Ÿ
â”‚   â”œâ”€â”€ æ‰¹é‡å®¡æ ¸
â”‚   â””â”€â”€ Before/After å¯¹æ¯”
â”œâ”€â”€ VLM è‡ªåŠ¨è¯„åˆ† (#6)
â”‚   â””â”€â”€ quality_scorer.py + æµç¨‹é›†æˆ
â””â”€â”€ å¤š Provider è§†é¢‘ç”Ÿæˆ (#3)
    â””â”€â”€ video_providers/ æŠ½è±¡å±‚

Week 4 (P3):
â””â”€â”€ ç»Ÿä¸€ GenerationService (#9)
    â”œâ”€â”€ base_gen_service.py
    â”œâ”€â”€ æœåŠ¡æ”¹é€ 
    â””â”€â”€ Metrics API
```

---

## æ–‡ä»¶å˜æ›´æ±‡æ€»

| æ“ä½œ | æ–‡ä»¶ | æ–¹å‘ |
|------|------|------|
| NEW | `backend/app/tasks/quick_draft_task.py` | #1 |
| NEW | `backend/app/api/quick_draft.py` | #1 |
| NEW | `frontend/src/components/QuickDraftWizard.tsx` | #1 |
| NEW | `backend/app/services/character_ref_gen.py` | #2 |
| NEW | `frontend/src/components/CharacterDesigner.tsx` | #2 |
| NEW | `backend/app/services/video_providers/base.py` | #3 |
| NEW | `backend/app/services/video_providers/seedance.py` | #3 |
| NEW | `backend/app/services/video_providers/kling.py` | #3 |
| NEW | `backend/app/services/video_providers/ffmpeg_fallback.py` | #3 |
| NEW | `backend/app/models/asset_version.py` | #4 |
| NEW | `backend/app/prompts/manager.py` | #5 |
| NEW | `backend/app/prompts/templates/default/*.txt` | #5 |
| NEW | `backend/app/api/styles.py` | #5 |
| NEW | `frontend/src/components/StylePicker.tsx` | #5 |
| NEW | `backend/app/services/quality_scorer.py` | #6 |
| NEW | `frontend/src/components/ProgressBar.tsx` | #7 |
| NEW | `frontend/src/components/Toast.tsx` | #7 |
| NEW | `frontend/src/components/CompareView.tsx` | #7 |
| NEW | `frontend/src/stores/useToastStore.ts` | #7 |
| NEW | `backend/app/services/pipeline_orchestrator.py` | #8 |
| NEW | `backend/app/tasks/pipeline_callbacks.py` | #8 |
| NEW | `backend/app/services/base_gen_service.py` | #9 |
| NEW | `backend/app/api/metrics.py` | #9 |
| MODIFY | `backend/app/models/project.py` | #1,#2,#5 |
| MODIFY | `backend/app/models/character.py` | #2 |
| MODIFY | `backend/app/models/scene.py` | #4 |
| MODIFY | `backend/app/services/ai_writer.py` | #5 |
| MODIFY | `backend/app/services/image_gen.py` | #2,#5 |
| MODIFY | `backend/app/services/video_gen.py` | #3,#9 |
| MODIFY | `backend/app/services/ffmpeg_service.py` | #3 |
| MODIFY | `backend/app/tasks/asset_tasks.py` | #4,#6,#8 |
| MODIFY | `backend/app/api/assets.py` | #7,#8 |
| MODIFY | `backend/app/config.py` | #3,#6 |
| MODIFY | `frontend/src/components/KanbanBoard.tsx` | #7 |
| MODIFY | `frontend/src/components/SceneCard.tsx` | #4 |
| MODIFY | `frontend/src/app/page.tsx` | #1,#5 |
| MODIFY | `frontend/src/app/layout.tsx` | #7 |
